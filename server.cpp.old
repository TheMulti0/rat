#include <winsock2.h>
#include <ws2tcpip.h>
#include <exception>
#include <cstdio>

#define DEFAULT_PORT "27015"
#define DEFAULT_IP "127.0.0.1"

void InitializeWinSock() {
    WSADATA wsaData;

    int startup = WSAStartup(MAKEWORD(2,2), &wsaData);

    if (startup != 0) {
        throw std::exception();
    }
}

addrinfo CreateHints() {
    addrinfo hints{};
    // For this application, the Internet address family is unspecified so that either an IPv6 or IPv4 address can be returned.
    hints.ai_family = AF_UNSPEC;
    // The application requests the socket type to be a stream socket for the TCP protocol.
    hints.ai_socktype = SOCK_STREAM;
    hints.ai_protocol = IPPROTO_TCP;
    return hints;
}

addrinfo* GetAddressInfo() {
    addrinfo* result = nullptr;
    addrinfo hints = CreateHints();

    int iResult = getaddrinfo(
            DEFAULT_IP,
            DEFAULT_PORT,
            &hints,
            &result);

    if (iResult != 0) {
        throw std::exception();
    }

    return result;
}

SOCKET GetConnectSocket(addrinfo *addressInfo) {
    SOCKET connectSocket = socket(
            addressInfo->ai_family,
            addressInfo->ai_socktype,
            addressInfo->ai_protocol);

    if (connectSocket == INVALID_SOCKET) {
        freeaddrinfo(addressInfo);
        throw std::exception();
    }

    return connectSocket;
}

int main(int argc, char const *argv[])
{
    InitializeWinSock();

    try {
        addrinfo *result = GetAddressInfo();

        SOCKET socket = GetConnectSocket(result);
    }
    catch (std::exception& e) {
        WSACleanup();
        throw e;
    }


    return 0;
}

